<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

    <head th:include="fragments.html :: header">
        <title id="pageTitle">Stogram - Просмотр поста</title>
    </head>

    <script th:inline="javascript">var contextPath = [[${#httpServletRequest.getContextPath()}]];</script>
    <script type="text/javascript" th:src="@{/resources/js/delete-post.js}"></script>
    <script type="text/javascript" th:src="@{/resources/js/jquery-1.11.0.min.js}"></script>
    <script>
        $(function(){
            $('.view-source .hide').hide();
            $a = $('.view-source a');
            $a.on('click', function(event) {
                event.preventDefault();
                $a.not(this).next().slideUp(500);
                $a.not(this).text('Посмотреть все комментарии');
                $(this).next().slideToggle(500);
                $(this).text($(this).text()=='Скрыть комментарии'?'Посмотреть все комментарии':'Скрыть комментарии');
            });
        });
    </script>
    <!-- Navigation -->
    <body>
        <nav class="navbar navbar-expand-lg navbar-light bg-light fixed-top" th:insert="fragments.html :: navigation"></nav>

        <!-- Page Content -->

        <br>
        <br>
        <div class="container">
            <br><br><br><br>
            <div class="row">
                <!-- Post Content Column -->
                <div class="col-lg-8">
                    <div class="form-group" th:object="${post}">
                        <input type="hidden" th:field="*{postId}"/>
                        <a th:if="${#authentication.name == post.user.username}" th:href="@{/post/{postId}/edit(postId = ${post.postId})}" class="btn btn-warning">Изменить</a>
                        <a th:if="${#authentication.name == post.user.username or #authorization.expression('hasRole(''ADMIN'')')}" th:href="@{/post/{postId}/delete(postId = ${post.postId})}" class="btn btn-danger">Удалить</a>
                        <img th:src="@{'/resources/img/' + ${post.user.username} + '/' + ${post.photo}}" th:height="600px">
                        <p th:text="*{content}"></p>
                            <span th:each="tag: *{tags}">
                                <a th:text="${tag.name}" th:href="@{/tag/{tagName}(tagName=${tag.name})}"></a>
                            </span>
                    </div>

                    <!-- Single Comment -->
                    <br>
                    <div class="view-source">
                        <a href="#" th:text="'Посмотреть все ' + ${countComments} + ' комментариев'"></a>
                        <div class="hide">
                            <br>
                            <div th:each="comment: ${post.comments}" class="media mb-4">
                                <div class="media-body">
                                    <b class="mt-0" th:text="${comment.user.username} + ' ' + ${#temporals.format(comment.createdAt, 'dd.MM.yyyy HH:mm')}"></b>
                                    <span th:text="${comment.content}"></span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Comments Form -->
                    <br>
                    <div sec:authorize="hasAnyRole('USER')">
                        <form method="POST" th:action="@{/comment/create}">
                            <div class="form-group">
                                <input type="hidden" name="postId" th:value="${post.postId}" />
                                <textarea class="form-control"  name="content" rows="3" placeholder="Написать комментарий"></textarea>
                            </div>
                            <br>
                            <button type="submit" class="btn btn-primary">-></button>
                        </form>
                    </div>

                </div>
            </div>
            <!-- /.row -->
        </div>
        <!-- /.container -->

        <!-- Footer -->
        <footer th:insert="fragments.html :: footer"></footer>

        <!-- Bootstrap core JavaScript -->
        <script src="vendor/jquery/jquery.min.js"></script>
        <script src="vendor/bootstrap/js/bootstrap.bundle.min.js"></script>

    </body>
</html>